name: Trivy Docker Image Scan

on:
  pull_request:
    branches:
      - main

jobs:
  trivy-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images with docker compose
        run: |
          docker compose build

      - name: Run Trivy vulnerability scanner on image
        id: trivy
        uses: aquasecurity/trivy-action@0.28.0
        env:
          TRIVY_DISABLE_VEX_NOTICE: "true"
        with:
          image-ref: mopat-webapp-container:latest
          format: json
          exit-code: 0
          output: trivy-report.json

      - name: Convert Trivy JSON to Markdown table (split OS vs app)
        run: |
          echo "### ðŸ” Trivy Vulnerability Scan Results" > trivy-comment.md
          echo "" >> trivy-comment.md

          # Check if any vulnerabilities exist
          if ! jq -e '.Results[].Vulnerabilities | select(length > 0)' trivy-report.json > /dev/null; then
            echo "âœ… No vulnerabilities found!" >> trivy-comment.md
            exit 0
          fi

          #####################################
          # ðŸ³ 1ï¸âƒ£ Base Image Vulnerabilities (os-pkgs)
          #####################################
          echo "## ðŸ³ Base Image (Ubuntu) Vulnerabilities" >> trivy-comment.md
          echo "" >> trivy-comment.md

          jq -r '
            [ .Results[]
              | select(.Class == "os-pkgs")
              | .Vulnerabilities[]?
            ]
            | select(length > 0)
            | group_by(.PkgName)
            | sort_by(.[0].PkgName)
            | .[]
            | "#### ðŸ“¦ Package: \([.[0].PkgName])\n"
              + "| Severity | Vulnerability ID | Installed Version | Fixed Version |\n"
              + "|-----------|------------------|------------------|----------------|\n"
              + (map("| \(.Severity) | \(.VulnerabilityID) | \(.InstalledVersion) | \(.FixedVersion // "-") |") | join("\n"))
              + "\n"
          ' trivy-report.json >> trivy-comment.md

          echo "" >> trivy-comment.md
          echo "---" >> trivy-comment.md
          echo "" >> trivy-comment.md

          #####################################
          # â˜•ï¸ 2ï¸âƒ£ Tomcat / Java / Library Vulnerabilities
          #####################################
          echo "## â˜•ï¸ Application / Library Vulnerabilities" >> trivy-comment.md
          echo "" >> trivy-comment.md

          jq -r '
            [ .Results[]
              | select(.Class != "os-pkgs")
              | .Vulnerabilities[]?
            ]
            | select(length > 0)
            | group_by(.PkgName)
            | sort_by(.[0].PkgName)
            | .[]
            | "#### ðŸ“¦ Package: \([.[0].PkgName])\n"
              + "| Severity | Vulnerability ID | Installed Version | Fixed Version |\n"
              + "|-----------|------------------|------------------|----------------|\n"
              + (map("| \(.Severity) | \(.VulnerabilityID) | \(.InstalledVersion) | \(.FixedVersion // "-") |") | join("\n"))
              + "\n"
          ' trivy-report.json >> trivy-comment.md

      - name: Create or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: trivy-comment.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
