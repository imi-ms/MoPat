name: Trivy Docker Image Scan

on: pull_request

jobs:
  trivy-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images with docker compose
        run: |
          docker compose build

      - name: Run Trivy vulnerability scanner on image
        id: trivy
        uses: aquasecurity/trivy-action@0.28.0
        env:
          TRIVY_DISABLE_VEX_NOTICE: "true"
        with:
          image-ref: mopat-webapp-container:latest
          format: json
          exit-code: 0
          output: trivy-report.json

      - name: Convert Trivy JSON to Markdown table (split OS vs app)
        run: |
          echo "### üîç Trivy Vulnerability Scan Results" > trivy-comment.md
          echo "" >> trivy-comment.md

          # Check if any vulnerabilities exist
          if ! jq -e '.Results[].Vulnerabilities | select(length > 0)' trivy-report.json > /dev/null; then
            echo "‚úÖ No vulnerabilities found!" >> trivy-comment.md
            exit 0
          fi

          #####################################
          # üê≥ 1Ô∏è‚É£ Base Image Vulnerabilities (os-pkgs)
          #####################################
          
          os_total=$(jq '[.Results[] | select(.Class=="os-pkgs") | .Vulnerabilities[]?] | length' trivy-report.json)
          os_with_fixes=$(jq '[.Results[] | select(.Class=="os-pkgs") | .Vulnerabilities[]? | select(.FixedVersion != null and .FixedVersion != "")] | length' trivy-report.json)
          
          echo "<details><summary>üê≥ Base Image Vulnerabilities: $os_total vulnerabilities found, $os_with_fixes with fixes</summary>" >> trivy-comment.md
          echo "" >> trivy-comment.md

          jq -r '
            [ .Results[]
              | select(.Class == "os-pkgs")
              | .Vulnerabilities[]?
            ]
            | select(length > 0)
            | group_by(.PkgName)
            | sort_by(.[0].PkgName)
            | .[]
            | "#### üì¶ Package: \([.[0].PkgName])\n"
              + "| Severity | Vulnerability ID | Installed Version | Fixed Version |\n"
              + "|-----------|------------------|------------------|----------------|\n"
              + (map("| \(.Severity) | \(.VulnerabilityID) | \(.InstalledVersion) | \(.FixedVersion // "-") |") | join("\n"))
              + "\n"
          ' trivy-report.json >> trivy-comment.md
          
          echo "</details>" >> trivy-comment.md
          echo "" >> trivy-comment.md
          echo "---" >> trivy-comment.md
          echo "" >> trivy-comment.md

          #####################################
          # ‚òïÔ∏è 2Ô∏è‚É£ Tomcat / Java / Library Vulnerabilities
          #####################################
          
          app_total=$(jq '[.Results[] | select(.Class!="os-pkgs") | .Vulnerabilities[]?] | length' trivy-report.json)
          app_with_fixes=$(jq '[.Results[] | select(.Class!="os-pkgs") | .Vulnerabilities[]? | select(.FixedVersion != null and .FixedVersion != "")] | length' trivy-report.json)
          
          echo "<details><summary>‚òïÔ∏è Application / Library Vulnerabilities: $app_total vulnerabilities found, $app_with_fixes with fixes</summary>" >> trivy-comment.md
          echo "" >> trivy-comment.md

          jq -r '
            [ .Results[]
              | select(.Class != "os-pkgs")
              | .Vulnerabilities[]?
            ]
            | select(length > 0)
            | group_by(.PkgName)
            | sort_by(.[0].PkgName)
            | .[]
            | "#### üì¶ Package: \([.[0].PkgName])\n"
              + "| Severity | Vulnerability ID | Installed Version | Fixed Version |\n"
              + "|-----------|------------------|------------------|----------------|\n"
              + (map("| \(.Severity) | \(.VulnerabilityID) | \(.InstalledVersion) | \(.FixedVersion // "-") |") | join("\n"))
              + "\n"
          ' trivy-report.json >> trivy-comment.md
          
          echo "</details>" >> trivy-comment.md

      - name: Create or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: trivy-comment.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
