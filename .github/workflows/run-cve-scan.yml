name: Trivy Docker Image Scan

on:
  pull_request:
    branches:
      - main

jobs:
  trivy-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images with docker compose
        run: |
          docker compose build

      - name: Run Trivy vulnerability scanner on image
        id: trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: mopat-webapp-container:latest
          format: table
          exit-code: 0
          output: trivy-report.txt

      - name: Post PR comment with Trivy Results
        if: always() && github.event_name == 'pull_request'
        run: |
          echo '### ðŸ” Trivy Vulnerability Scan Results:' > trivy-comment.md
          echo '```' >> trivy-comment.md
          cat trivy-report.txt >> trivy-comment.md
          echo '```' >> trivy-comment.md
        shell: bash

      - name: Create or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: trivy-comment.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
