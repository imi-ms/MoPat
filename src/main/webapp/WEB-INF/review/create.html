<th:block
        layout:decorate="~{layout/main}"
        th:with="title=${messages.get(#locale, 'review.create.heading.createReview', 'Create Review for Questionnaire')}"
>
    <th:block layout:fragment="content">
        <div class="panel-body">

            <form
                    id="createReviewForm"
                    action="/review/create"
                    method="POST"
                    th:object="${createReviewForm}"
                    enctype="application/x-www-form-urlencoded"
            >
                <!-- Select reviewer -->
                <div class="form-group">
                    <label class="required" for="reviewerId" th:text="${messages.get(#locale, 'review.create.label.reviewer', 'Select Reviewer')}"></label>
                    <select id="reviewerId" name="reviewerId" class="form-control" th:field="*{reviewerId}" onchange="handleQuestionnaireChange()">
                        <option th:each="reviewer : ${reviewers}"
                                th:value="${reviewer.id}"
                                th:text="${reviewer.firstname + ' ' + reviewer.lastname}">
                        </option>
                    </select>
                    <div class="text-danger" th:if="${#fields.hasErrors('reviewerId')}" th:errors="*{reviewerId}"></div>
                </div>

                <!-- Select questionnaire -->
                <div class="form-group">
                    <label class="required" for="questionnaireId" th:text="${messages.get(#locale, 'review.create.label.questionnaire', 'Select Questionnaire')}"></label>
                    <select id="questionnaireId" name="questionnaireId" class="form-control" th:field="*{questionnaireId}">
                        <option th:each="questionnaire : ${questionnaires}"
                                th:value="${questionnaire.id}"
                                th:data-version="${questionnaire.version}"
                                th:text="${questionnaire.name}">
                        </option>
                    </select>
                    <div class="text-danger" th:if="${#fields.hasErrors('questionnaireId')}" th:errors="*{questionnaireId}"></div>
                </div>

                <!-- Select mail language -->
                <div class="form-group">
                    <label class="required" for="language" th:text="${messages.get(#locale, 'review.create.label.language', 'Language')}"></label>
                    <select id="language" name="language" class="form-control" th:field="*{language}">
                        <option value="en_GB" th:selected="${language == 'en_GB'}">English (GB)</option>
                        <option value="de_DE" th:selected="${language == 'de_DE'}">Deutsch (DE)</option>
                    </select>
                    <div class="text-danger" th:if="${#fields.hasErrors('language')}" th:errors="*{language}"></div>
                </div>

                <!-- Description of the changes -->
                <div class="form-group">
                    <label for="description" 
                        id="descriptionLabel"
                        th:text="${messages.get(#locale, 'review.label.description', 'Description of changes')}"
                        th:title="${messages.get(#locale, 'review.label.description.title', 'Will be displayed in the conversation of the review')}">
                    </label>
                    <textarea id="description" 
                        name="description" 
                        class="form-control" 
                        rows="5"
                        th:field="*{description}">
                    </textarea>
                    <div class="text-danger" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
                </div>

                <!-- Personal message -->
                <div class="form-group">
                    <label for="personalMessage" th:text="${messages.get(#locale, 'review.label.personalMessage', 'Personal Message (Email only)')}"></label>
                    <textarea id="personalMessage"
                        name="personalMessage"
                        class="form-control"
                        rows="5"
                        th:field="*{personalMessage}">
                    </textarea>
                    <div class="text-danger" th:if="${#fields.hasErrors('personalMessage')}" th:errors="*{personalMessage}"></div>
                </div>

                <!-- Preview area -->
                 <div>
                    <div id="previewArea" style="display: none; border: 1px solid #ccc; padding: 10px; margin-bottom: 15px;">
                        <h4 th:text="${messages.get(#locale, 'review.create.label.previewArea', 'Preview')}"></h4>
                        <!-- Subject -->
                        <div class="form-group">
                            <label th:text="${messages.get(#locale, 'review.create.label.previewSubject', 'Subject')}"></label>
                            <pre
                                id="previewSubject"
                                style="white-space: pre; padding: 10px; overflow-x: auto;"
                            ></pre>
                        </div>
                        <!-- Content -->
                        <div class="form-group">
                            <label th:text="${messages.get(#locale, 'review.create.label.previewContent', 'Content')}"></label>
                            <pre
                                id="previewContent"
                                style="white-space: pre; padding: 10px; overflow-x: auto;"
                            ></pre>
                        </div>
                    </div>
                </div>

               <!-- Buttons -->
                <div class="d-flex justify-content-start gap-2">
                    <button type="submit" class="btn btn-primary" th:text="${messages.get(#locale, 'review.create.button.sendRequest', 'Send request')}"></button>
                    <button type="button" id="previewButton" class="btn btn-primary" data-action="invitation" th:text="${messages.get(#locale, 'review.create.button.preview', 'Preview')}"></button>
                    <a href="/review/pending/list" class="btn btn-primary" th:text="${messages.get(#locale, 'button.cancel', 'Cancel')}"></a>
                </div>
            </form>

        </div>
    </th:block>
</th:block>
<th:block layout:fragment="scriptContainer">
<script th:inline="javascript" type="text/javascript">

    document.getElementById("previewButton").addEventListener("click", function () {
        const language = document.getElementById("language").value;
        const questionnaireName = $("#questionnaireId :selected").text();
        const description = document.getElementById("description").value.trim();
        const personalMessage = document.getElementById("personalMessage").value.trim();
        const action = this.getAttribute("data-action");

        // Encode data into URL parameters
        const params = new URLSearchParams({
            language: language,
            action: action,
            questionnaireName: questionnaireName,
            description: description,
            personalMessage: personalMessage
        });

        // Fetch the preview data
        fetch(`/review/preview-email?${params}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to load email preview");
                }
                return response.json();
            })
            .then(preview => {
                // Update the preview fields
                document.getElementById("previewSubject").textContent = preview.subject;
                document.getElementById("previewContent").textContent = preview.content;
                document.getElementById("previewArea").style.display = "block";
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Failed to load email preview. Please try again.");
            });
    });

    document.getElementById("questionnaireId").addEventListener("change", function () {
        handleQuestionnaireChange();
    });

    function handleQuestionnaireChange() {
        const questionnaireSelect = document.getElementById("questionnaireId");
        const selectedOption = questionnaireSelect.options[questionnaireSelect.selectedIndex];
        const version = parseInt(selectedOption.dataset.version, 10); // Read version
        const descriptionField = document.getElementById("description");
        const descriptionLabel = document.getElementById("descriptionLabel");

        if (version > 1) {
            // Set the field to “required” and add the asterisk
            descriptionField.setAttribute("required", "true");
            descriptionLabel.classList.add("required");
        } else {
            // Remove “required” and the asterisk
            descriptionField.removeAttribute("required");
            descriptionLabel.classList.remove("required");
        }
    }
</script> 
</th:block>